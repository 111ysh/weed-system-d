name: 数据处理流水线（DVC数据更新触发）

on:
  push:
    branches: [ dev ]
    paths:
      - '**/*.dvc'

jobs:
  data-validation:
    runs-on: ubuntu-latest

    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      - name: 安装DVC并拉取数据
        uses: iterative/setup-dvc@v3
        with:
          dvc-version: '2.58.0'

      - name: 拉取DVC数据集
        run: dvc pull
        env:
          DVC_REMOTE_URL: ${{ secrets.DVC_REMOTE_URL }}
          DVC_REMOTE_USER: ${{ secrets.DVC_REMOTE_USER }}
          DVC_REMOTE_PASS: ${{ secrets.DVC_REMOTE_PASS }}

      - name: 配置Python环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'

      - name: 安装依赖包
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 执行数据质量校验
        run: python data_quality_check.py
        env:
          DATASET_PATH: './datasets/processed'
          VALIDATION_LOG_PATH: './data_validation.log'

      - name: 上传校验日志
        uses: actions/upload-artifact@v4
        with:
          name: data-validation-log
          path: ${{ env.VALIDATION_LOG_PATH }}
